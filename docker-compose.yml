version: "3.1"
services:

  eureka-service:
    image: hidenxtt2001/social-shop-eureka-service:latest
    ports:
      - 8761:8761
    networks:
      - main

  gateway-service:
    image: hidenxtt2001/social-shop-api-gateway:latest
    environment:
      - EUREKA_HOST=http://eureka-service:8761/eureka
    ports:
      - 8080:8080
    depends_on:
      eureka-service:
        condition: service_started
    networks:
      - main

  auth-redis:
    image: redis/redis-stack-server:latest
    networks:
      - auth

  auth-database:
    image: mysql:latest
    environment:
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD}
    restart: on-failure
    volumes:
      - "./scripts/db/auth-service:/docker-entrypoint-initdb.d"
    networks:
      - auth
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 10s
      retries: 10

  auth-service:
    image: hidenxtt2001/social-shop-auth-service:latest
    environment:
      - MYSQL_HOST=jdbc:mysql://auth-database:3306/auth?allowPublicKeyRetrieval=true&useSSL=false
      - MYSQL_PASSWORD=${DATABASE_PASSWORD}
      - EUREKA_HOST=http://eureka-service:8761/eureka
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY}
      - REDIS_HOST_URL=auth-redis
      - REDIS_HOST_PORT=6379
    depends_on:
      eureka-service:
        condition: service_started
      gateway-service:
        condition: service_started
      auth-database:
        condition: service_healthy
      auth-redis:
        condition: service_started
    networks:
      - main
      - auth

networks:
  main:
    driver: bridge
  auth:
    driver: bridge

volumes:
  mysql:









